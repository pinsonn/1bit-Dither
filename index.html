<!DOCTYPE HTML>
<html>
<head>


</head>
<body style="font-family:arial">
<div style="float:left">
<canvas id="canvas" width="800" height="600" style="border:1px solid black;"></canvas>
</div>

<div style="float:left;margin-left:20px;">
			<div class="tool">Scan Pattern:&nbsp;<input type="radio" name="scan_pattern" class="" value="1" checked/>Raster&nbsp;
					  <input type="radio" name="scan_pattern" class="" value="0"/>Serpentine&nbsp;
			</div>
			<div class="tool">Scan Direction:&nbsp;<input type="radio" name="scan_direction" class="" value="1" checked/>Horizontal&nbsp;
					  <input type="radio" name="scan_direction" class="" value="0"/>Vertical&nbsp;
			</div>
</div>
<script src="./scripts/jquery-1.7.2.min.js"></script>
<script>
(function($){

	function dither(imgData, vertical_scan, raster){
		var data = imgData.data;
		var w = imgData.width;
		var h = imgData.height;
		var d_index = 0;
		var new_value, old_value, err;
		var x = y = 0;
		var dx = dy = 1;
		
		if (raster){
			rasterScan();
		} else {
			serpentineScan();
		}

		return data;

		function rasterScan(){
			if (vertical_scan){
				for(y = 0; y < h; y++){
					for (x = 0; x < w; x++){
						diffuseError();
					}
				}
			} else {
				for (x = 0; x < w; x++){
					for(y = 0; y < h; y++){
						diffuseError();
					}
				}
			}	
		}


		function serpentineScan(){
			if (vertical_scan){
				while (x < w){
					diffuseError();
					y += dy;

					if (y === h){
						dy = -1;
						x += 1;
					} 

					if (y === -1){
						dy = 1;
						x += 1;
					}
				}
			} else {
				while (y < h){
					diffuseError();
					x += dx;
					if (x === w){
						dx = -1;
						y += 1;
					} 
					if (x === -1){
						dx = 1;
						y += 1;
					}
				}
			}
		}

// private member function to calculate and propogate 
// the error to adjacent pixels
// according to the atkinson dithering algorithm
//	    x  1/8 1/8 
//     1/8 1/8 1/8
//         1/8

		function diffuseError(){
				var nxy = [{x: x+1, y: y},
					   {x: x+2, y: y},
					   {x: x-1, y: y+1},
					   {x: x, y: y+1},
					   {x: x+1, y: y+1},
					   {x: x, y: y+2}];
				d_index = findDataIndex(x, y, w);	
				old_value = data[d_index];
				new_value = (old_value > 128) ? 255 : 0;
				data[d_index] = data[d_index + 1] = data[d_index + 2] = new_value;
				err = (old_value - new_value) >> 3;
				$.each(nxy, function(i, px){
					if (inBounds(px.x, px.y, w, h)){
						var o_index = findDataIndex(px.x, px.y, w);
						var val = data[o_index];
						data[o_index] = data[o_index + 1] = data[o_index + 2] = val + err;
					}
				});
		}

// private member function to find corresponding index within the imageData.data array 
// for a given pixel at coordinate (x,y);

		function findDataIndex(x, y, width){
			return (y*width*4) + (x*4);
		}

// private member function to test whether a given pixel lies within the bounds of 
// image

		function inBounds(x, y, width, height){
			if((x >= 0) && (x < width)){
				if ((y >= 0) && (y < height)){
					return true;
				}
			}
			return false;
		}
	};

	function toBinary(imgData){
		var output = [];
		var data = imgData.data;
		for (var i=0; i < imgData.width * imgData.height; i+=1){
			output[i] = (data[i*4] === 255) ? 1 : 0; 
		}
		return output;
	};

	function grayscale(imgData){
		var r,g,b,a,l;
		var data = imgData.data;

		for (var i=0; i< data.length; i+=4){
			r = data[i];
			g = data[i + 1];
			b = data[i + 2];
			a = data[i + 3];

			l = 0.299*r + 0.587*g + 0.114*b;
			data[i] = data[i+1] = data[i+2] = l;
		}	
		imgData.data = data;
		return imgData;
	};

	var canvas = $("#canvas")[0];
	var ctx = canvas.getContext("2d");
	var w = canvas.width;
	var h = canvas.height;
	var img = new Image();
	img.vertical_scan = false;
	img.raster = true;
	img.onload = function(){
		var img_w = this.width;
		var img_h = this.height;
		var ar = img_w/img_h;
		if ((img_w > w) || (img_h > h)){

	// image won't fit. Scale it appropriately while preserving aspect ratio 
	// and center it on the canvas

			if (img_w > img_h){
				ctx.drawImage(this,0,0.5*(h-(w/ar)),w,w/ar);
			} else {
				ctx.drawImage(this,0.5*(w- (h*ar)),0,h*ar,h);
			}
		} else {

	// image fits. draw it. 

			ctx.drawImage(this,0,0);
		}

		this.original_img_data = ctx.getImageData(0,0,canvas.width, canvas.height);
	        var imgData = grayscale(this.original_img_data);	
		imgData.data = dither(imgData, img.vertical_scan, img.raster);
		ctx.putImageData(imgData,0,0);
	};


	ctx.font = '40px Arial';
	ctx.textAlign = 'center';
	ctx.fillStyle = "#a4a4a4";
	ctx.fillText("Drop An Image Here", 400, 300);

	$('input:radio[name="scan_direction"]').change(function(){
		img.vertical_scan = (+$(this).val()) ? false : true;
		img.onload();
	});

	$('input:radio[name="scan_pattern"]').change(function(){
		img.raster = (+$(this).val()) ? true : false;
		img.onload();
	});

	$('#canvas').bind('dragover', function(evt){

	// prevent the browser from loading the image when it's dropped
	// use the "copy" cursor effect on dragover

		evt = evt.originalEvent;
		evt.stopPropagation();
		evt.preventDefault();
		evt.dataTransfer.dropEffect = 'copy';
	});

	$('#canvas').bind('drop', function(evt){

	// reference the original event, prevent default action, and bubbling

		evt = evt.originalEvent;

		evt.stopPropagation();
		evt.preventDefault();
		
		// get an array of files dropped on the canvas. Even if multiple files are dropped, only use the first


		var files = evt.dataTransfer.files; // FileList object.
	
		// create a file reader object in order to read the file
		// use the readAsDataURL method to get the data URL
		// set the underlay src to the dataURL using the onload method
		// of the file reader object

		var reader = new FileReader();
		reader.onload = function(e){
			ctx.clearRect(0, 0, w, h);
			img.src = e.target.result;
		// img.onload gets called once src is done loading
		}

		reader.readAsDataURL(files[0]);
	});

})(jQuery);
</script>
</body>
</html>
